

<head>
   <meta charset="utf-8" />
   <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
   <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
   <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
   <link rel="stylesheet" href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css">
   <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.2.2/css/buttons.bootstrap.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/sql/sql.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/default.min.css">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
   <script src="https://codemirror.net/lib/codemirror.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.40.0/mode/javascript/javascript.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.0/mode/xml/xml.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.10.2/beautify.js"></script>
   <script src="https://codemirror.net/addon/hint/sql-hint.js"></script>
   <script src="https://codemirror.net/addon/hint/show-hint.js"></script>
   <script src="https://codemirror.net/mode/sql/sql.js"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">
   <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.9.3/intro.min.js"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/2.9.3/introjs.min.css">
   </script>
</head>

<style>
   .CodeMirror {
   height: 50%;
   width: 100%;
   border-radius: 5px;
   word-wrap: break-word;
   white-space: pre-wrap;
   border: 1px solid #ccc;
   border-radius: 4px;
   }
   textarea { word-wrap: break-word; }
   .CodeMirror-sizer {
   padding-bottom: 10px !important;
   white-space: pre-wrap
   }
   div.editable {
   width: 300px;
   height: 200px;
   border: 1px solid #ccc;
   padding: 5px;
   }
   strong {
   font-weight: bold;
   }
   <!-- .navbar { -->
     <!-- border-radius: 30px; -->
<!-- } -->
</style>

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <a class="navbar-brand" href="#">SQL Snippet Manager</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarColor02">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
        </li>
		<li class="nav-item">
          <a id="navOptions" class="nav-link" href="#" data-toggle="modal" data-target="#exampleModal" data-intro='Input API keys and manage configuration settings here.'>Options</a>
        </li>
		<!-- <li class="nav-item"> -->
          <!-- <a class="nav-link" id="btnTutorial" href="#">Tutorial</a> -->
        <!-- </li> -->
      </ul>
    </div>
  </nav>
  
<div class="container">

	<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">SQL Snippet Manager Config</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon1">API Key</span>
  </div>
  <input id="txtAPI" type="text" class="form-control" aria-label="Username" aria-describedby="basic-addon1">
</div>

<!-- <div class="input-group mb-3"> -->
  <!-- <div class="input-group-prepend"> -->
    <!-- <span class="input-group-text" id="basic-addon2">API Secret</span> -->
  <!-- </div> -->
  <!-- <input id="txtSecret" type="text" class="form-control"  aria-label="Username" aria-describedby="basic-addon1"> -->
<!-- </div> -->

<div class="input-group mb-3">
  <div class="input-group-prepend" >
    <span class="input-group-text" id="basic-addon2">Email</span>
  </div>
  <input readonly id="txtEmail" type="text" class="form-control"  aria-label="Username" aria-describedby="basic-addon1">
</div>

<div class="input-group">
   <button id="btnRestartTut"type="button" class="btn btn-info w-100" data-toggle="modal" data-target="#exampleModal">Restart Tutorial</button>
</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button id = "btnSaveOptions" type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

   <div class="row mt-3">
      <form action="search" method="post" >
   </div>
   <div class="input-group mb-3" data-intro='
   Enter a snippet name to create your first snippet, if the snippet already exists it will be updated.
   <br/>If the snippet name is new it will create a new snippet.
   <br/>With a cleared textfield Press the â†“ arrow key to view all snippets'>
      <div class="input-group-prepend" >  
         <span class="input-group-text" id="basic-addon1">@</span>  
      </div>
      <input id="project-name" name="project2" id="searchbox" class="form-control"/>  
   </div>
   <div data-intro='Type the SQL code into the text area'>
   <br>
   <br>	 
   <textarea  class="editor" id="project-id">
		  </textarea>
    </div>
   <br>
   <div class="row">
      <button id="btnSave" type="button" class="btn btn-success ml-5 mr-5" data-intro='When ready to save click green button'><i class="far fa-save"></i></button>
      <button id="btnCopy"type="button" class="btn btn-info ml-5 mr-5" data-intro='Click the blue copy button to copy snippet to clipboard'><i class="fas fa-copy"></i></button>
      <button id="btnClear" type="button" class="btn btn-danger ml-5 mr-5"data-intro='Click the red trashcan button to clear all text areas'><i class="far fa-trash-alt"></i></button>
   </div>
</div>
<script>
//Vars
var curUUID = "";
var localonly = 0;
var uniqueId = "";
var availableTags = [];
	
//Cookie Functions

function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires=" + d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function checkCookie() {
    var newUser = getCookie("newSQLSnippetUser");
    if (newUser != "False") {
        introJs().start();
        setCookie("newSQLSnippetUser", "False", 365);
    }
}

//Button Click Listeners
$("#btnCopy").click(function() {
    var txt = editor.getDoc().getValue();
    copyToClp(txt);
    toastr.info("Snippet copied to clipboard");
});

$("#btnRestartTut").click(function() {
    introJs().start();
});

$("#navOptions").click(function() {
    var ApiKey = getCookie("APIKey");
    var ApiSec = getCookie("APISecret");
    var Email = getCookie("Email");

    $("#txtAPI").val(ApiKey);
    $("#txtSecret").val(ApiSec);
	var txt = document.getElementById("txtEmail").readOnly = false;      
    $("#txtEmail").val(Email);
	document.getElementById("txtEmail").readOnly = true;
});



$("#btnSave").click(function() {
    loadToCloud();
	reloadTags();
	setTimeout(function() 
	{
    reloadTags();
	},1000);
});

$("#btnClear").click(function() {
    $("#project-name").val("");
    editor.setValue("");
    toastr.error("Cleared all text");
});

$("#btnTutorial").click(function() {
    introJs().start();
});

$("#btnSaveOptions").click(function() {
    var APIKey = $("#txtAPI").val();
    var APISecret = $("#txtSecret").val();
    var Email = $("#txtEmail").val();

    setCookie("APIKey", APIKey, 90);
    setCookie("APISecret", APISecret, 90);
    setCookie("Email", Email, 90);

    toastr.success("Configurations Updated!");
});



//Stored API Key In Cookie, test response messages

checkCookie();
if (localonly == 0) {
    reloadTags();

    var editor = CodeMirror.fromTextArea(document.getElementById("project-id"), {
        mode: 'text/x-mssql',
        lineNumbers: true,
        lineWrapping: true,
        showTrailingSpace: true
    });

    editor.setOption("extraKeys", {
        Tab: function(cm) {
            var spaces = Array(cm.getOption("indentUnit") + 2).join(" ");
            cm.replaceSelection(spaces);
        }
    });

    editor.setValue("");
    $("#project-id").val("");
    $("#project-name").val("");
} 
<!--{value: "PIVOT",key: "SELECT VendorID,[250] AS Emp1,[251] AS Emp2,[256] AS Emp3,[257] AS Emp4,[260] AS Emp5 \nFROM(\n\tSELECT PurchaseOrderID, EmployeeID, VendorID  \n\tFROM Purchasing.PurchaseOrderHeader\n\t) p \nPIVOT(COUNT(PurchaseOrderID) FOR EmployeeID IN([250],[251],[256],[257],[260])) AS pvt\nORDER BY pvt.VendorID; "}, -- >

toastr.options = {
    'closeButton': true,
    'debug': false,
    'newestOnTop': false,
    'progressBar': true,
    'positionClass': 'toast-top-center',
    'preventDuplicates': false,
    'showDuration': '1000',
    'hideDuration': '1000',
    'timeOut': '5000',
    'extendedTimeOut': '1000',
    'showEasing': 'swing',
    'hideEasing': 'linear',
    'showMethod': 'fadeIn',
    'hideMethod': 'fadeOut',
}
//Copy To Clip Board
function copyToClp(txt) {
    txt = document.createTextNode(txt);
    var m = document;
    var w = window;
    var b = m.body;
    b.appendChild(txt);
    if (b.createTextRange) {
        var d = b.createTextRange();
        d.moveToElementText(txt);
        d.select();
        m.execCommand('copy');
    } else {
        var d = m.createRange();
        var g = w.getSelection;
        d.selectNodeContents(txt);
        g().removeAllRanges();
        g().addRange(d);
        m.execCommand('copy');
        g().removeAllRanges();
    }
    txt.remove();
}


//availableTags.push({value: "STUFFX", key: "SELECT STUFF(( SELECT ',' + EMPLOYEEID FROM [#TEMP_A] FOR XML PATH('')), 1, 1, '') as Employees"}); 

function saveAll(data, filename, type) {
    var file = new Blob([data], {
        type: type
    });
    if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
        var a = document.createElement("a"),
            url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
    }
    //location.reload(); 
}


function insertStringInTemplate(str) {
    var doc = editor.getDoc();
    var cursor = doc.getCursor();

    var pos = {
        line: cursor.line,
        ch: cursor.ch
    }

    doc.replaceRange(str, pos);
}

function updateCodeMirror(data) {
    var doc = editor.getDoc();
    editor.focus();
    var cursor = doc.getCursor(); // gets the line number in the cursor position
    var line = doc.getLine(cursor.line); // get the line contents
    var pos = { // create a new object to avoid mutation of the original selection
        line: cursor.line,
        ch: line.length - 1 // set the character position to the end of the line
    }
    doc.replaceRange('\n' + data, pos); // adds a new line
}

$(function() {
    $("#project-name").autocomplete({
        minLength: 0,
        source: availableTags,
        focus: function(event, ui) {
            $("#project-name").val(ui.item.value);
            return false;
        },
        select: function(event, ui) {
            $("#project-name").val(ui.item.value);
            $("#project-id").val(ui.item.key);
            var x = "" + ui.item.key;
            editor.setValue("");
            var words = x.split("/n");

            editor.focus();
            // Set the cursor at the end of existing content
            editor.setCursor(editor.lineCount());

            var lineCount = editor.lineCount(); // current number of lines
            var n = words.length; // how many lines we need
            var line = editor.getCursor().line;
            var ch = editor.getCursor().ch;

            for (i = 0; i < n; i++) {
                var t = words[i];
                editor.focus();
                editor.replaceRange("\n", {
                    line,
                    ch
                });
                editor.replaceRange(words[i], {
                    line,
                    ch
                });
                line++;
            }
            return false;
        }
    });
});

var $box = $('.pixel').mousedown(function() {
    $(this).toggleClass('highlight');
    var flag = $(this).hasClass('highlight')
    $box.on('mouseenter.highlight', function() {
        $(this).toggleClass('highlight', flag);
    });
});

//Post to here : http://www.dpriver.com/cgi-bin/ppserver

function reloadTags() {
    var t = [];

    var xhr = new XMLHttpRequest();
    xhr.open("GET", "https://aowwobgm06.execute-api.us-east-2.amazonaws.com/default/SQLSnippetManager", true);
    xhr.setRequestHeader('Access-Control-Allow-Headers', '*');
    xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('x-api-key', getCookie("APIKey"));
	//xhr.setRequestHeader('x-api-key', "");

    xhr.send();
    xhr.onload = function() {
        var response = JSON.parse(this.responseText);
		console.log(response);
        var count = Object.keys(response).length;
        //var datax = JSON.parse(response['body']);
		var datax = response; //Use this if lambda proxy is enabled.
        for (i = 0; i < Object.keys(datax).length; i++) {
            var x = datax[i].value;
            var y = datax[i].key;
            var z = datax[i].uuid;
            y = y.replace(/_/g, ' ');
            t.push({
                uuid: z,
                value: x,
                key: y
            });
        }
        availableTags = t;

        setTimeout(function() {
            $("#project-name").autocomplete({
                minLength: 0,
                source: availableTags,
                focus: function(event, ui) {
                    $("#project-name").val(ui.item.value);
                    return false;
                },
                select: function(event, ui) {
                    $("#project-name").val(ui.item.value);
                    $("#project-id").val(ui.item.key);
                    var x = "" + ui.item.key;
                    editor.setValue("");
                    var words = x.split("/n");

                    editor.focus();
                    editor.setCursor(editor.lineCount());

                    var lineCount = editor.lineCount(); // current number of lines
                    var n = words.length; // how many lines we need
                    var line = editor.getCursor().line;
                    var ch = editor.getCursor().ch;

                    for (i = 0; i < n; i++) {
                        var t = words[i];
                        editor.focus();
                        editor.replaceRange("\n", {
                            line,
                            ch
                        });
                        editor.replaceRange(words[i], {
                            line,
                            ch
                        });
                        line++;
                    }
                    return false;
                }
            });
        }, 500);
    }
}

function loadToCloud() {
    var xhr = new XMLHttpRequest();
    var str = editor.getValue('<br>');
    var regex = /<br\s*[\/]?>/gi;
    var snippetName = $("#project-name").val();
    if (availableTags.some(e => e.value == snippetName)) {

        var selected = [snippetName];
        for (var i = 0, length = availableTags.length; i < length; i++) {
            if (availableTags[i]['value'] == snippetName) {
                uniqueId = availableTags[i]['uuid']
            }
        }
        toastr.success("Snippet has been updated!");
    } else {
        toastr.success("New snippet has been added!");
        uniqueId = Math.random().toString(36).substring(2) + Date.now().toString(36);
        console.log('Not Exists');
    }

    var snippetValue = str.replace(regex, '/n'); //?key1=4&key2=" + snippetName + "&key3=" + snippetValue
    var snippetValueF = snippetValue.replace(/\s/g, '_');
    console.log("https://aowwobgm06.execute-api.us-east-2.amazonaws.com/default/SQLSnippetManager?key1=" + uniqueId + "&key2=" + snippetName + "&key3=" + snippetValueF);
    xhr.open("Post", "https://aowwobgm06.execute-api.us-east-2.amazonaws.com/default/SQLSnippetManager?key1=" + uniqueId + "&key2=" + snippetName + "&key3=" + snippetValueF, true);
    xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
	xhr.setRequestHeader('x-api-key', getCookie("APIKey"));
    //xhr.setRequestHeader('x-api-key', '');
    xhr.send();
    xhr.onload = function() {
        var response = JSON.parse(this.responseText);
        console.log(response);
    }
    reloadTags();
}


</script>

